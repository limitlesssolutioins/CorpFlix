generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// --- CONFIGURACIÓN ORGANIZACIONAL ---

model Site {
  id        String   @id @default(uuid())
  name      String
  address   String?
  employees Employee[] 
  shifts    Shift[]    
}

model Position {
  id        String   @id @default(uuid())
  name      String
  employees Employee[]
  shifts    Shift[]
}

// --- EMPLEADOS ---

model Employee {
  id              String   @id @default(uuid())
  firstName       String
  lastName        String
  identification  String   @unique 
  email           String?  @unique
  phone           String?
  
  contractType    String   
  salaryAmount    Decimal
  salaryScheme    String   
  startDate       DateTime
  
  epsEntity       String
  arlEntity       String
  pensionEntity   String
  
  defaultSiteId   String
  defaultSite     Site     @relation(fields: [defaultSiteId], references: [id])
  defaultPositionId String
  defaultPosition Position @relation(fields: [defaultPositionId], references: [id])
  
  teamId          String?
  team            Team?    @relation(fields: [teamId], references: [id])
  
  standardStartTime String? 
  standardEndTime   String? 
  standardStartTime2 String? 
  standardEndTime2   String? 

  workDays          String? 

  shifts          Shift[]
  absences        Absence[]
  attendances     Attendance[]
  documents       EmployeeDocument[]
  notifications   NotificationLog[]
  
  sentSwaps       ShiftSwapRequest[] @relation("SwapRequester")
  receivedSwaps   ShiftSwapRequest[] @relation("SwapTarget")

  payslips        Payslip[]
  liquidations    Liquidation[]

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- NÓMINA (PAYROLL) ---

model PayrollPeriod {
  id          String    @id @default(uuid())
  name        String    // Ej: "Primera Quincena Enero 2026"
  startDate   DateTime
  endDate     DateTime
  paymentDate DateTime?
  status      String    @default("DRAFT") // DRAFT, PROCESSING, CLOSED, PAID
  
  payslips    Payslip[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model PayrollConcept {
  id             String   @id @default(uuid())
  code           String   @unique // Ej: SALARY, TRANSPORT_AID, HEALTH, PENSION, OT_DAY
  name           String
  type           String   // EARNING, DEDUCTION, PROVISION
  isSystem       Boolean  @default(false)
  formula        String?
  
  payslipDetails PayslipDetail[]
}

model Payslip {
  id              String        @id @default(uuid())
  periodId        String
  period          PayrollPeriod @relation(fields: [periodId], references: [id])
  
  employeeId      String
  employee        Employee      @relation(fields: [employeeId], references: [id])
  
  grossSalary     Decimal       @default(0)
  totalDeductions Decimal       @default(0)
  netSalary       Decimal       @default(0)
  
  daysWorked      Int           @default(0)
  
  details         PayslipDetail[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([periodId, employeeId])
}

model PayslipDetail {
  id          String         @id @default(uuid())
  payslipId   String
  payslip     Payslip        @relation(fields: [payslipId], references: [id])
  
  conceptId   String
  concept     PayrollConcept @relation(fields: [conceptId], references: [id])
  
  amount      Decimal
  units       Decimal?
  percentage  Decimal?
  
  createdAt   DateTime       @default(now())
}

// --- LIQUIDACIÓN (TERMINATION) ---

model Liquidation {
  id              String   @id @default(uuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  separationDate  DateTime
  reason          String   // VOLUNTARY, JUST_CAUSE, UNJUST_CAUSE, END_OF_CONTRACT
  
  salaryBase      Decimal
  
  severance       Decimal // Cesantías
  severanceInterest Decimal // Intereses
  serviceBonus    Decimal // Prima
  vacation        Decimal // Vacaciones
  indemnification Decimal // Indemnización
  
  totalAmount     Decimal
  
  status          String   @default("DRAFT") // DRAFT, APPROVED, PAID
  
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- ASISTENCIA REAL (Punto 2) ---

model Attendance {
  id              String   @id @default(uuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  shiftId         String?  
  shift           Shift?   @relation(fields: [shiftId], references: [id])
  
  checkIn         DateTime @default(now())
  checkOut        DateTime?
  
  latitude        Float?
  longitude       Float?
  
  status          String   @default("ON_TIME") // ON_TIME, LATE, EARLY_LEAVE
  observations    String?
  
  createdAt       DateTime @default(now())
}

// --- GESTIÓN DOCUMENTAL (Punto 4) ---

model EmployeeDocument {
  id              String   @id @default(uuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  title           String   
  category        String   
  fileUrl         String   
  expiryDate      DateTime? 
  
  createdAt       DateTime @default(now())
}

// --- NOTIFICACIONES (Punto 3) ---

model NotificationLog {
  id              String   @id @default(uuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  type            String   
  message         String
  status          String   @default("SENT") 
  
  createdAt       DateTime @default(now())
}

// --- SMART SCHEDULER ---

model Team {
  id        String     @id @default(uuid())
  name      String     
  employees Employee[]
}

model ShiftPattern {
  id          String   @id @default(uuid())
  name        String   
  description String?  
  sequence    String   
  createdAt   DateTime @default(now())
}

// --- AUDITORÍA Y CONTROL ---

model AuditLog {
  id          String   @id @default(uuid())
  entity      String   
  entityId    String
  action      String   
  details     String?  
  performedBy String   @default("Sistema") 
  createdAt   DateTime @default(now())
}

model ShiftSwapRequest {
  id            String   @id @default(uuid())
  requestDate   DateTime @default(now())
  
  shiftId       String
  shift         Shift    @relation(fields: [shiftId], references: [id])
  
  requesterId   String
  requester     Employee @relation("SwapRequester", fields: [requesterId], references: [id])
  
  targetId      String
  target        Employee @relation("SwapTarget", fields: [targetId], references: [id])
  
  status        String   @default("PENDING") 
  reason        String?
  managerComment String?
}

// --- NOVEDADES ---

model AbsenceType {
  code                String  @id 
  name                String
  paidBy              String  
  percentage          Decimal 
  affectsTransportAid Boolean 
  absences            Absence[]
}

model Absence {
  id                  String      @id @default(uuid())
  employeeId          String
  employee            Employee    @relation(fields: [employeeId], references: [id])
  
  absenceTypeCode     String
  absenceType         AbsenceType @relation(fields: [absenceTypeCode], references: [code])
  
  startDate           DateTime
  endDate             DateTime
  
  diagnosisCode       String?     
  medicalCertificateUrl String?   
  
  status              String      @default("PENDING_APPROVAL") 
  
  conflicts           ShiftConflict[]
  
  createdAt           DateTime    @default(now())
}

// --- TURNOS ---

model Shift {
  id              String   @id @default(uuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  siteId          String
  site            Site     @relation(fields: [siteId], references: [id])
  positionId      String
  position        Position @relation(fields: [positionId], references: [id])
  
  startTime       DateTime
  endTime         DateTime
  
  conflictStatus  String   @default("NONE") 
  
  conflicts       ShiftConflict[]
  swapRequests    ShiftSwapRequest[]
  attendances     Attendance[]

  createdAt       DateTime @default(now())
}

model ShiftConflict {
  id              String   @id @default(uuid())
  shiftId         String
  shift           Shift    @relation(fields: [shiftId], references: [id])
  
  absenceId       String
  absence         Absence  @relation(fields: [absenceId], references: [id])
  
  conflictMessage String
  createdAt       DateTime @default(now())
}

// --- CONFIGURACIÓN GLOBAL ---

model SystemConfiguration {
  id              String   @id @default(uuid())
  companyName     String   @default("Nombre de la Empresa")
  idType          String   @default("NIT") // NIT, CC, CE, etc.
  nit             String?
  logoUrl         String?  
  address         String?
  city            String?  @default("Cartagena")
  taxRegime       String?  @default("Régimen Común")
  
  // Preferencias de Operación
  paymentFrequency String  @default("MONTHLY") // MONTHLY, BIWEEKLY
  
  currentYear     Int      @default(2026)
  smlmv           Decimal  
  transportAid    Decimal  

  payrollConfig   Json?
  
  updatedAt       DateTime @updatedAt
}

model SalaryScale {
  id        String   @id @default(uuid())
  name      String   
  amount    Decimal  
  createdAt DateTime @default(now())
}

model Holiday {
  id        String   @id @default(uuid())
  date      DateTime @unique 
  name      String   
}

// --- PAGOS Y SUSCRIPCIONES ---

model Payment {
  id              String   @id @default(uuid())
  amount          Decimal
  currency        String   @default("COP")
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED
  type            String   // SUBSCRIPTION, ONE_TIME
  method          String   // PSE, CARD
  reference       String   @unique
  description     String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Subscription {
  id              String   @id @default(uuid())
  planName        String
  status          String   @default("INACTIVE") // ACTIVE, INACTIVE, EXPIRED
  startDate       DateTime?
  endDate         DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
